# Ch.25 쓰레드는 개발자라면 알아두는 것이 좋아요

---
- java 명령어로 프로그램 시작 -> JVM이 시작됨 -> 하나의 자바 프로세스가 시작됨 => 하나의 프로세스 내에는 최소 하나 이상의 쓰레드가 존재함.
  - 아무 일도 일어나고 있지 않은 서버더라도 다양한 스레드가 돌아가고 있음
    - ex: 실행시키고 아무 요청이 없는 서버라도 GC 스레드가 계속 돌고 있음\

#### 왜 쓰레드를 만들었을까?
- 프로세스가 시작하려면 많은 자원이 필요함 -> 여러개의 프로세스를 만드는 것은 비효율적이기에, 그 하위 개념은 쓰레드를 만들어 경량화 함.

### Runnalble 인터페이스와 Thread 클래스
- 자바에서 쓰레드를 생성하는 방법: Runnable & Thread.
  - Thread 클래스는 Runnable의 구현체이기에 사실상 Runnable 이 다함.
- run() 메서드는 쓰레드가 수행되는 구현부
- start() 메서드는 쓰레드를 시작시킴
- 자바에서는 단일 상속만 허용하기 때문에, 특정 클래스에서 다른 어떠한 클래스르 상속해야 한다면 Thread를 상속받을 수 없어진다. 이러한 상황이 있기 때문에 Runnable 이라는 인터페이스를 이용한 구현 방법을 남겨둔 듯 하다.

---
### 데몬 스레드

- 데몬 스레드는 데몬 스레드로 등록된 자신외에 실행중인 스레드가 없다면 종료되는 스레드이다.
- start 메서드를 실행하기 전에 반드시 setDaemon(true) 를 해줘야 데몬스레드가 된다.
- 왜 필요한가?
  - 모니터링 기능등, 프로그램 시작시 부터 종료시점까지 반드시 필요한 기능이나 별도의 다른 프로세스가 돌고있지 않다면 종료시켜야하는 경우에 사용

---

### synchronized

- java의 동시성의 원인은 인스턴스 변수이고, 이 인스턴스 변수에 접근하는 경우 락을 걸어 모든 스레드에서 순차적으로 처리하게 해주는 예약어.
- 메서드에 걸면 해당 메서드가 순차적으로 실행되어 보장이됨.

---
### Thread를 통제하는 메서드들
- Thread.State 의 상수 목록:
  - NEW: 쓰레드 객체는 생성되었으나 시작(start)하지 않은 상태
  - RUNNABLE: 쓰레드가 실행중인 상태
    - 스레드 스케쥴러에 의해 실행 준비 단계이거나 실행중이된 경우
  - BLOCKED: 쓰레드가 실행 중지 상태. 모니터 락이 풀리기를 기다리는 상태
    - Monitor lock 이 뭘까? 
      - 먼저 Monitor 를 알아야함:
        - 동시에 여러 스레드가 접근하면 안 되는 공유 자원(critical section)을 안전하게 보호하기 위한 동기화(synchronization) 도구 
        - 자바에서는 synchronized 키워드로 구현돼 있고, 모든 객체(Object)가 모니터를 하나씩 갖고 있음.
          - 자바 객체는 “데이터”만 가진 게 아니라 모니터(lock + 대기열)라는 동기화 도구도 함께 가지고 있다
      - 모니터 락은?
        - 어떤 스레드가 synchronized(obj) 블록이나 synchronized 메서드에 들어가려고 할 때, 그 객체(obj)의 모니터 락을 먼저 획득해야 함.
        - 한 시점에 단 하나의 스레드만 모니터 락을 소유할 수 있음 -> 락을 획득한 스레드가 synchronized 블록을 다 빠져나오면, 락은 자동으로 반환(release)
  - WAITING: 쓰레드가 대기중인 상태
    - wait, join, LockSupport.park 등의 메서드로 대기중인 상태.
  - TIMED_WAITING: 특정 시간만큼 대기중인 상태
    - thread.sleep(long), wait, join 등 특정 시간 만큼 대기 시키는 메서드에 걸린 경우 변경되는 상태.
  - TERMINATED: 쓰레드가 종료됨

- interrupt()
  - 현재 수행중인 쓰레드를 중단시키는 메서드로, 중단 시키면서 InterruptedException 을 발생시킴.
  - 이미 종료된 (TERMINATED) 상태의 스레드에 해당 메서드가 호출되어도 아무일도 일어나지 않는다.
    - 예외나 에러 없음 
  - stop()이 있었으나 deprecated 됨

---
### Object 클래스에 선언된 쓰레드와 관련있는 메서드들
- wait -> 다른 쓰레드에서 해당 객체의 notify() 혹은 notifyall() 메서드를 실행시키기 전까지 현재 스레드를 대기 상태로 만듬
- notify / notifyall -> 객체의 모니터에 대기하고 있는 하나/전체 스레드를 꺠운다